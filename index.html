<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES Package Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1em;
        }
        
        .content {
            padding: 25px;
        }
        
        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .input-group textarea {
            height: 70px;
            resize: vertical;
            font-family: monospace;
            font-size: 12px;
        }
        
        .required::after {
            content: " *";
            color: #e74c3c;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-export {
            background: #9b59b6;
            color: white;
        }
        
        .breadcrumb {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .breadcrumb span {
            color: #7f8c8d;
        }
        
        .breadcrumb .active {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .breadcrumb .separator {
            margin: 0 10px;
            color: #bdc3c7;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: #34495e;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .clickable {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
        }
        
        .clickable:hover {
            color: #2980b9;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-CF {
            background: #d4edda;
            color: #155724;
        }
        
        .status-RO {
            background: #fff3cd;
            color: #856404;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results-info {
            background: #e8f4fd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .cookie-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .hidden {
            display: none;
        }
        
        .back-button {
            margin-bottom: 15px;
        }
        
        .header-with-copy {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #ecf0f1;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .small-btn {
            padding: 8px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ MES Package Management</h1>
            <p>Qu·∫£n l√Ω v√† theo d√µi package MES system</p>
        </div>
        
        <div class="content">
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb" id="breadcrumb">
                <span class="active">T√¨m ki·∫øm Package</span>
            </div>

            <!-- Configuration Section -->
            <div class="config-section" id="configSection">
                <h2>üîç T√¨m ki·∫øm Package Ch√≠nh</h2>
                
                <div class="input-group">
                    <label for="cookieInput" class="required">MES Cookie:</label>
                    <textarea id="cookieInput" placeholder="D√°n cookie t·ª´ MES system..."></textarea>
                    <small style="color: #666; font-size: 12px;">L·∫•y cookie t·ª´ MES system qua Developer Tools (F12)</small>
                </div>

                <div class="config-grid">
                    <div class="input-group">
                        <label for="factory" class="required">Factory:</label>
                        <input type="text" id="factory" value="P2C1">
                    </div>
                    
                    <div class="input-group">
                        <label for="buyer" class="required">Buyer:</label>
                        <input type="text" id="buyer" value="ONR">
                    </div>
                    
                    <div class="input-group">
                        <label for="aoNumber">AO Number:</label>
                        <input type="text" id="aoNumber" value="0141">
                    </div>
                    
                    <div class="input-group">
                        <label for="startDate" class="required">Start Date:</label>
                        <input type="date" id="startDate">
                    </div>
                    
                    <div class="input-group">
                        <label for="endDate" class="required">End Date:</label>
                        <input type="date" id="endDate" readonly>
                    </div>
                    
                    <div class="input-group">
                        <label for="styleCode">Style Code:</label>
                        <input type="text" id="styleCode">
                    </div>
                    
                    <div class="input-group">
                        <label for="buyerPO">Buyer PO:</label>
                        <input type="text" id="buyerPO">
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="testHealth()">
                        <span>ü©∫</span> Ki·ªÉm tra tr·∫°ng th√°i worker
                    </button>
                    <button class="btn-success" onclick="getGroupPackages()">
                        <span>üì¶</span> L·∫•y danh s√°ch package ch√≠nh
                    </button>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>

            <!-- Group Packages Results -->
            <div id="groupPackagesResults" class="hidden">
                <div class="export-buttons">
                    <button class="btn-export small-btn" onclick="exportGroupPackagesCSV()">
                        <span>üìä</span> Xu·∫•t CSV Package Groups
                    </button>
                </div>
                <div class="results-info">
                    üìä T√¨m th·∫•y <strong id="resultCount">0</strong> package ch√≠nh
                </div>
                <div class="table-container">
                    <table id="groupPackagesTable">
                        <thead>
                            <tr>
                                <th>
                                    <div class="header-with-copy">
                                        Package Group
                                        <button class="copy-btn" onclick="copyAllPackageGroups()" title="Copy t·∫•t c·∫£ Package Groups">
                                            üìã
                                        </button>
                                    </div>
                                </th>
                                <th>Style Code</th>
                                <th>Buyer PO</th>
                                <th>Target Qty</th>
                                <th>Status</th>
                                <th>Plan Start Date</th>
                                <th>Plan End Date</th>
                                <th>Style Colorways</th>
                            </tr>
                        </thead>
                        <tbody id="groupPackagesBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- MES Packages Results -->
            <div id="mesPackagesResults" class="hidden">
                <div class="back-button">
                    <button class="btn-secondary" onclick="backToGroupPackages()">
                        <span>‚Üê</span> Quay l·∫°i danh s√°ch package ch√≠nh
                    </button>
                </div>
                <div class="export-buttons">
                    <button class="btn-export small-btn" onclick="exportMxPackagesCSV()">
                        <span>üìä</span> Xu·∫•t CSV Mx Packages
                    </button>
                </div>
                <div class="results-info">
                    üìã MES Packages c·ªßa: <strong id="currentPackageGroup"></strong>
                    <button class="copy-btn" onclick="copyAllMxPackages()" title="Copy t·∫•t c·∫£ Mx Packages">
                        üìã Copy Mx Packages
                    </button>
                </div>
                <div class="table-container">
                    <table id="mesPackagesTable">
                        <thead>
                            <tr>
                                <th>
                                    <div class="header-with-copy">
                                        MxPackage
                                        <button class="copy-btn" onclick="copyAllMxPackages()" title="Copy t·∫•t c·∫£ Mx Packages">
                                            üìã
                                        </button>
                                    </div>
                                </th>
                                <th>Line Name</th>
                                <th>MxStatus</th>
                                <th>PlnStartDate</th>
                                <th>PlnEndDate</th>
                                <th>FinishedQty</th>
                                <th>MxTarget</th>
                                <th>WorkingHours</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mesPackagesBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pro Packages Results -->
            <div id="proPackagesResults" class="hidden">
                <div class="back-button">
                    <button class="btn-secondary" onclick="backToMxPackages()">
                        <span>‚Üê</span> Quay l·∫°i MES Packages
                    </button>
                </div>
                <div class="results-info">
                    üîß Package con c·ªßa: <strong id="currentProPackage"></strong>
                </div>
                <div class="table-container">
                    <table id="proPackagesTable">
                        <thead>
                            <tr>
                                <th>PPackage</th>
                                <th>SeqNo</th>
                                <th>OrdQty</th>
                                <th>PlanQty</th>
                                <th>CompletedQty</th>
                                <th>Line No</th>
                                <th>QCO Week</th>
                                <th>Destination</th>
                            </tr>
                        </thead>
                        <tbody id="proPackagesBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="cookie-note">
                <strong>üí° H∆∞·ªõng d·∫´n l·∫•y Cookie:</strong><br>
                1. M·ªü MES system trong browser v√† ƒëƒÉng nh·∫≠p<br>
                2. Nh·∫•n F12 ‚Üí Tab Network<br>
                3. T·∫£i l·∫°i trang MES ‚Üí T√¨m request t·ªõi mespk2.pungkookvn.com<br>
                4. Copy gi√° tr·ªã header "Cookie" t·ª´ request ƒë√≥
            </div>
        </div>
    </div>

    <script>
        // Worker URL (hidden from user)
        const WORKER_URL = "https://mes-csv-export.chiscoong-cloudflare-com.workers.dev";
        
        // Current state and data storage
        let currentState = 'group';
        let currentPackageGroup = '';
        let currentProPackage = '';
        let allGroupPackages = [];
        let allMxPackages = [];

        // DOM Elements
        const elements = {
            breadcrumb: document.getElementById('breadcrumb'),
            configSection: document.getElementById('configSection'),
            loading: document.getElementById('loading'),
            groupPackagesResults: document.getElementById('groupPackagesResults'),
            proPackagesResults: document.getElementById('proPackagesResults'),
            mesPackagesResults: document.getElementById('mesPackagesResults'),
            groupPackagesBody: document.getElementById('groupPackagesBody'),
            proPackagesBody: document.getElementById('proPackagesBody'),
            mesPackagesBody: document.getElementById('mesPackagesBody'),
            resultCount: document.getElementById('resultCount'),
            currentPackageGroup: document.getElementById('currentPackageGroup'),
            currentProPackage: document.getElementById('currentProPackage')
        };

        // Initialize date fields
        function initializeDates() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setMonth(today.getMonth() - 1); // Default to 1 month ago
            
            const endDate = new Date(startDate);
            endDate.setMonth(startDate.getMonth() + 6); // +6 months from start
            
            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            
            // Update end date when start date changes
            document.getElementById('startDate').addEventListener('change', function() {
                const start = new Date(this.value);
                const end = new Date(start);
                end.setMonth(start.getMonth() + 6);
                document.getElementById('endDate').valueAsDate = end;
            });
        }

        // Update breadcrumb
        function updateBreadcrumb(state, packageGroup = '', proPackage = '') {
            let breadcrumbHTML = '';
            
            if (state === 'group') {
                breadcrumbHTML = '<span class="active">T√¨m ki·∫øm Package</span>';
            } else if (state === 'mes') {
                breadcrumbHTML = `
                    <span class="clickable" onclick="backToGroupPackages()">T√¨m ki·∫øm Package</span>
                    <span class="separator">‚Ä∫</span>
                    <span class="active">MES Packages: ${packageGroup}</span>
                `;
            } else if (state === 'pro') {
                breadcrumbHTML = `
                    <span class="clickable" onclick="backToGroupPackages()">T√¨m ki·∫øm Package</span>
                    <span class="separator">‚Ä∫</span>
                    <span class="clickable" onclick="backToMxPackages()">MES Packages: ${packageGroup}</span>
                    <span class="separator">‚Ä∫</span>
                    <span class="active">Pro Package: ${proPackage}</span>
                `;
            }
            
            elements.breadcrumb.innerHTML = breadcrumbHTML;
        }

        // Show/hide sections
        function showSection(section) {
            elements.configSection.classList.add('hidden');
            elements.groupPackagesResults.classList.add('hidden');
            elements.proPackagesResults.classList.add('hidden');
            elements.mesPackagesResults.classList.add('hidden');
            
            if (section === 'config') {
                elements.configSection.classList.remove('hidden');
            } else if (section === 'group') {
                elements.groupPackagesResults.classList.remove('hidden');
            } else if (section === 'pro') {
                elements.proPackagesResults.classList.remove('hidden');
            } else if (section === 'mes') {
                elements.mesPackagesResults.classList.remove('hidden');
            }
        }

        // Loading states
        function showLoading() {
            elements.loading.style.display = 'block';
        }

        function hideLoading() {
            elements.loading.style.display = 'none';
        }

        // API request function
        async function makeRequest(endpoint, params = {}) {
            const cookieInput = document.getElementById('cookieInput').value.trim();
            
            if (!cookieInput) {
                alert('Vui l√≤ng nh·∫≠p MES Cookie!');
                return null;
            }

            showLoading();
            
            try {
                const url = new URL(endpoint, WORKER_URL);
                Object.keys(params).forEach(key => {
                    if (params[key]) {
                        url.searchParams.set(key, params[key]);
                    }
                });

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-MES-Cookie': cookieInput,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                return data;
                
            } catch (error) {
                alert(`L·ªói: ${error.message}`);
                return null;
            } finally {
                hideLoading();
            }
        }

        // Test health check
        async function testHealth() {
            const data = await makeRequest('/health');
            if (data) {
                alert(`‚úÖ Worker ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!\nTimestamp: ${data.timestamp}`);
            }
        }

        // Get group packages
        async function getGroupPackages() {
            const params = {
                factory: document.getElementById('factory').value,
                plnStartDate: document.getElementById('startDate').value.replace(/-/g, ''),
                plnEndDate: document.getElementById('endDate').value.replace(/-/g, ''),
                buyer: document.getElementById('buyer').value,
                aoNumber: document.getElementById('aoNumber').value,
                styleInf: document.getElementById('styleCode').value,
                buyerPO: document.getElementById('buyerPO').value,
                _search: 'false',
                rows: '50',
                page: '1',
                sidx: 'BuyerPO',
                sord: 'asc'
            };

            const data = await makeRequest('/api/group-packages', params);
            
            if (data && data.success) {
                displayGroupPackages(data.data);
            }
        }

        // Display group packages
        function displayGroupPackages(data) {
            if (!data.rows || data.rows.length === 0) {
                alert('Kh√¥ng t√¨m th·∫•y package n√†o!');
                return;
            }

            allGroupPackages = data.rows;
            elements.resultCount.textContent = data.rows.length;
            
            let tableHTML = '';
            data.rows.forEach(row => {
                tableHTML += `
                    <tr>
                        <td>
                            <span class="clickable" onclick="getMxPackages('${row.PackageGroup}')">
                                ${row.PackageGroup}
                            </span>
                        </td>
                        <td>${row.StyleCode || ''}</td>
                        <td>${row.BuyerPO || ''}</td>
                        <td>${row.TargetQty?.toLocaleString() || 0}</td>
                        <td>
                            <span class="status-badge status-${row.Status}">
                                ${row.StatusName || row.Status}
                            </span>
                        </td>
                        <td>${row.MesPlnStartDate || ''}</td>
                        <td>${row.MesPlnEndDate || ''}</td>
                        <td>${row.StyleColorways || ''}</td>
                    </tr>
                `;
            });
            
            elements.groupPackagesBody.innerHTML = tableHTML;
            showSection('group');
            updateBreadcrumb('group');
            currentState = 'group';
        }

        // Get MES packages (ƒë·∫£o l√™n tr∆∞·ªõc)
        async function getMxPackages(packageGroup) {
            currentPackageGroup = packageGroup;
            
            const data = await makeRequest('/api/mes-packages', { 
                packageGroup: packageGroup,
                mesPkgType: 'P'
            });
            
            if (data && data.success) {
                displayMxPackages(data.data, packageGroup);
            }
        }

        // Display MES packages
        function displayMxPackages(data, packageGroup) {
            allMxPackages = data;
            elements.currentPackageGroup.textContent = packageGroup;
            
            let tableHTML = '';
            data.forEach(row => {
                tableHTML += `
                    <tr>
                        <td>
                            <span class="clickable" onclick="copyMxPackage('${row.MxPackage}')" title="Click ƒë·ªÉ copy">
                                ${row.MxPackage || ''}
                            </span>
                        </td>
                        <td>${row.LineName || ''}</td>
                        <td>
                            <span class="status-badge status-${row.MxStatus}">
                                ${row.StatusName || row.MxStatus}
                            </span>
                        </td>
                        <td>${row.PlnStartDate || ''}</td>
                        <td>${row.PlnEndDate || ''}</td>
                        <td>${row.FinishedQty?.toLocaleString() || 0}</td>
                        <td>${row.MxTarget?.toLocaleString() || 0}</td>
                        <td>${row.WorkingHours || 0}</td>
                        <td>
                            <button class="btn-info small-btn" onclick="getProPackages('${row.MxPackage}')">
                                üîß Pro Packages
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            elements.mesPackagesBody.innerHTML = tableHTML;
            showSection('mes');
            updateBreadcrumb('mes', packageGroup);
            currentState = 'mes';
        }

        // Get pro packages (ƒë·ªÉ trong n√∫t Actions)
        async function getProPackages(mxPackage) {
            currentProPackage = mxPackage;
            
            const data = await makeRequest('/api/pro-packages', { 
                packageGroup: currentPackageGroup 
            });
            
            if (data && data.success) {
                displayProPackages(data.data, mxPackage);
            }
        }

        // Display pro packages
        function displayProPackages(data, mxPackage) {
            elements.currentProPackage.textContent = mxPackage;
            
            let tableHTML = '';
            data.forEach(row => {
                tableHTML += `
                    <tr>
                        <td>${row.PPackage || ''}</td>
                        <td>${row.SeqNo || ''}</td>
                        <td>${row.OrdQty?.toLocaleString() || 0}</td>
                        <td>${row.PlanQty?.toLocaleString() || 0}</td>
                        <td>${row.CompletedQty?.toLocaleString() || 0}</td>
                        <td>${row.LINENO || ''}</td>
                        <td>${row.QCOWeekNo || ''}</td>
                        <td>${row.Destination || ''}</td>
                    </tr>
                `;
            });
            
            elements.proPackagesBody.innerHTML = tableHTML;
            showSection('pro');
            updateBreadcrumb('pro', currentPackageGroup, mxPackage);
            currentState = 'pro';
        }

        // Copy functions
        function copyAllPackageGroups() {
            const packageGroups = allGroupPackages.map(pkg => pkg.PackageGroup).join('\n');
            navigator.clipboard.writeText(packageGroups).then(() => {
                alert(`ƒê√£ copy ${allGroupPackages.length} Package Groups!`);
            });
        }

        function copyAllMxPackages() {
            const mxPackages = allMxPackages.map(pkg => pkg.MxPackage).join('\n');
            navigator.clipboard.writeText(mxPackages).then(() => {
                alert(`ƒê√£ copy ${allMxPackages.length} Mx Packages!`);
            });
        }

        function copyMxPackage(mxPackage) {
            navigator.clipboard.writeText(mxPackage).then(() => {
                alert(`ƒê√£ copy: ${mxPackage}`);
            });
        }

        // Export CSV functions
        function exportGroupPackagesCSV() {
            if (allGroupPackages.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                return;
            }

            const headers = ['PackageGroup', 'StyleCode', 'BuyerPO', 'TargetQty', 'Status', 'MesPlnStartDate', 'MesPlnEndDate', 'StyleColorways'];
            const csvContent = [
                headers.join(','),
                ...allGroupPackages.map(row => 
                    headers.map(header => 
                        `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                    ).join(',')
                )
            ].join('\n');

            downloadCSV(csvContent, 'package-groups.csv');
        }

        function exportMxPackagesCSV() {
            if (allMxPackages.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                return;
            }

            const headers = ['MxPackage', 'LineName', 'MxStatus', 'StatusName', 'PlnStartDate', 'PlnEndDate', 'FinishedQty', 'MxTarget', 'WorkingHours'];
            const csvContent = [
                headers.join(','),
                ...allMxPackages.map(row => 
                    headers.map(header => 
                        `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                    ).join(',')
                )
            ].join('\n');

            downloadCSV(csvContent, `mx-packages-${currentPackageGroup}.csv`);
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Navigation functions
        function backToGroupPackages() {
            showSection('group');
            updateBreadcrumb('group');
            currentState = 'group';
        }

        function backToMxPackages() {
            showSection('mes');
            updateBreadcrumb('mes', currentPackageGroup);
            currentState = 'mes';
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            initializeDates();
            updateBreadcrumb('group');
        });
    </script>
</body>
</html>
