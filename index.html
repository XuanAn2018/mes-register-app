<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES Package Management System</title>
    <style>
        /* === C√ÅC THI·∫æT L·∫¨P C∆† B·∫¢N === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh; /* C·ªë ƒë·ªãnh chi·ªÅu cao ƒë·ªÉ scroll n·ªôi dung b√™n trong */
        }
        
        /* === HEADER === */
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header h1 { font-size: 1.5em; display: flex; align-items: center; gap: 10px; }
        .header-meta { font-size: 0.9em; opacity: 0.8; }
        
        /* === N·ªòI DUNG CH√çNH (SCROLLABLE) === */
        .content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        /* === CONFIG SECTION === */
        .config-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .input-group input:focus, .input-group textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }
        
        .input-group textarea { height: 60px; resize: vertical; font-family: monospace; }
        
        .button-group {
            display: flex; gap: 10px; margin-top: 20px;
        }
        
        button {
            padding: 10px 18px; border: none; border-radius: 6px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 8px;
        }
        
        button:hover { filter: brightness(110%); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-export { background: #8e44ad; color: white; }

        /* === B·∫¢NG D·ªÆ LI·ªÜU (TABLE) === */
        .table-wrapper {
            background: white;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 600px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho b·∫£ng ƒë·ªÉ scroll */
        }

        .results-toolbar {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-scroll {
            overflow: auto;
            flex: 1;
        }
        
        table {
            width: 100%;
            border-collapse: separate; /* Quan tr·ªçng cho sticky header */
            border-spacing: 0;
            font-size: 13px;
        }
        
        th {
            background: #f1f2f6;
            color: #2c3e50;
            padding: 12px 10px;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #ddd;
            user-select: none;
        }

        /* Style cho c·ªôt c√≥ th·ªÉ s·∫Øp x·∫øp */
        th.sortable {
            cursor: pointer;
            transition: background 0.2s;
            padding-right: 25px; /* Ch·ª´a ch·ªó cho icon */
            position: relative;
        }

        th.sortable:hover {
            background: #e2e6ea;
            color: #3498db;
        }

        /* Icon s·∫Øp x·∫øp */
        th.sortable::after {
            content: '‚Üï';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
            font-size: 11px;
        }

        th.sortable.asc::after {
            content: '‚ñ≤';
            opacity: 1;
            color: #3498db;
        }

        th.sortable.desc::after {
            content: '‚ñº';
            opacity: 1;
            color: #3498db;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        tr:nth-child(even) { background-color: #fcfcfc; }
        tr:hover { background-color: #f1f8ff; }
        
        /* === UI C√ÅC TR·∫†NG TH√ÅI === */
        .status-badge {
            padding: 5px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .status-CF { background: #d4edda; color: #155724; } /* Confirmed */
        .status-RO { background: #fff3cd; color: #856404; } /* Requested */
        .status-DR { background: #e2e3e5; color: #383d41; } /* Draft */
        
        .clickable {
            color: #3498db; cursor: pointer; text-decoration: none; font-weight: 600;
        }
        .clickable:hover { text-decoration: underline; color: #2980b9; }
        
        .loading { display: none; text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none; }
        .text-right { text-align: right; }
        .font-mono { font-family: 'Consolas', monospace; }
        
        .copy-icon-btn {
            background: none; border: none; color: #95a5a6;
            cursor: pointer; padding: 4px; border-radius: 4px;
        }
        .copy-icon-btn:hover { color: #3498db; background: rgba(52, 152, 219, 0.1); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ MES Package Manager</h1>
            <div class="header-meta">Qu·∫£n l√Ω v√† theo d√µi ti·∫øn ƒë·ªô s·∫£n xu·∫•t</div>
        </div>
        
        <div class="content">
            <!-- Breadcrumb -->
            <div id="breadcrumb" style="margin-bottom: 15px; font-size: 14px; color: #666;">
                <span style="font-weight: bold; color: #2c3e50;">T√¨m ki·∫øm Package</span>
            </div>

            <!-- Configuration Section -->
            <div class="config-section" id="configSection">
                <div class="input-group">
                    <label for="cookieInput" style="color: #e74c3c;">MES Cookie :</label>
                    <textarea id="cookieInput" placeholder="D√°n cookie t·ª´ F12 -> Network -> Request Header..."></textarea>
                </div>

                <div class="config-grid">
                    <div class="input-group"><label>Factory</label><input type="text" id="factory" value="P2C1"></div>
                    <div class="input-group"><label>Buyer</label><input type="text" id="buyer" value="ONR"></div>
                    <div class="input-group"><label>AO Number</label><input type="text" id="aoNumber" value="0141"></div>
                    <div class="input-group"><label>Start Date</label><input type="date" id="startDate"></div>
                    <div class="input-group"><label>End Date</label><input type="date" id="endDate"></div>
                    <div class="input-group"><label>Style Code</label><input type="text" id="styleCode"></div>
                    <div class="input-group"><label>Buyer PO</label><input type="text" id="buyerPO"></div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="testHealth()">ü©∫ Ki·ªÉm tra Server</button>
                    <button class="btn-success" onclick="getGroupPackages()">üì¶ T√¨m ki·∫øm Package</button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ch·ªù...</p>
            </div>

            <!-- Group Packages Results -->
            <div id="groupPackagesResults" class="hidden">
                <div class="table-wrapper">
                    <div class="results-toolbar">
                        <div>
                            T√¨m th·∫•y <strong id="resultCount" style="color: #3498db;">0</strong> packages
                        </div>
                        <div class="button-group" style="margin-top: 0;">
                            <button class="btn-info small-btn" onclick="copyAllPackageGroups()">üìã Copy All Groups</button>
                            <button class="btn-export small-btn" onclick="exportGroupPackagesCSV()">üìä Xu·∫•t CSV</button>
                        </div>
                    </div>
                    <div class="table-scroll">
                        <table id="groupPackagesTable">
                            <thead>
                                <tr>
                                    <th>Package Group</th>
                                    <th>Style Code</th>
                                    <th>Buyer PO</th>
                                    <!-- C√ÅC C·ªòT C√ì TH·ªÇ S·∫ÆP X·∫æP -->
                                    <th class="sortable text-right" onclick="sortGroupTable('TargetQty', 'number')">Target Qty</th>
                                    <th class="sortable" onclick="sortGroupTable('Status', 'string')">Status</th>
                                    <th class="sortable" onclick="sortGroupTable('MesPlnStartDate', 'date')">Plan Start Date</th>
                                    <th class="sortable" onclick="sortGroupTable('MesPlnEndDate', 'date')">Plan End Date</th>
                                    <th class="sortable" onclick="sortGroupTable('StyleColorways', 'string')">Style Colorways</th>
                                </tr>
                            </thead>
                            <tbody id="groupPackagesBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- MES Packages Results -->
            <div id="mesPackagesResults" class="hidden">
                <div class="table-wrapper">
                    <div class="results-toolbar">
                        <div>
                            <button class="btn-secondary small-btn" onclick="backToGroupPackages()">‚Üê Quay l·∫°i</button>
                            <span style="margin-left: 15px;">Chi ti·∫øt: <strong id="currentPackageGroup"></strong></span>
                        </div>
                        <div class="button-group" style="margin-top: 0;">
                            <button class="btn-info small-btn" onclick="copyAllMxPackages()">üìã Copy All MxPkg</button>
                            <button class="btn-export small-btn" onclick="exportMxPackagesCSV()">üìä Xu·∫•t CSV</button>
                        </div>
                    </div>
                    <div class="table-scroll">
                        <table id="mesPackagesTable">
                            <thead>
                                <tr>
                                    <th>MxPackage</th>
                                    <th>Line Name</th>
                                    <th>Status</th>
                                    <th class="sortable" onclick="sortMesTable('PlnStartDate', 'date')">Start Date</th>
                                    <th class="sortable" onclick="sortMesTable('PlnEndDate', 'date')">End Date</th>
                                    <th class="text-right">Finished</th>
                                    <th class="text-right">Target</th>
                                    <th class="text-right">Hours</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mesPackagesBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pro Packages Results -->
            <div id="proPackagesResults" class="hidden">
                <div class="table-wrapper">
                    <div class="results-toolbar">
                        <div>
                            <button class="btn-secondary small-btn" onclick="backToMxPackages()">‚Üê Quay l·∫°i MES Pkg</button>
                            <span style="margin-left: 15px;">Pro Pkg c·ªßa: <strong id="currentProPackage"></strong></span>
                        </div>
                    </div>
                    <div class="table-scroll">
                        <table id="proPackagesTable">
                            <thead>
                                <tr>
                                    <th>PPackage</th>
                                    <th>Seq</th>
                                    <th class="text-right">Ord Qty</th>
                                    <th class="text-right">Plan Qty</th>
                                    <th class="text-right">Completed</th>
                                    <th>Line No</th>
                                    <th>QCO Week</th>
                                    <th>Dest</th>
                                </tr>
                            </thead>
                            <tbody id="proPackagesBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        const WORKER_URL = "https://mes-csv-export.chiscoong-cloudflare-com.workers.dev";
        
        let currentState = 'group';
        let currentPackageGroup = '';
        let allGroupPackages = []; // D·ªØ li·ªáu g·ªëc
        let allMxPackages = [];    // D·ªØ li·ªáu g·ªëc
        
        // Tr·∫°ng th√°i s·∫Øp x·∫øp
        let sortState = {
            column: null,
            direction: 'asc' // 'asc' ho·∫∑c 'desc'
        };

        // --- KH·ªûI T·∫†O V√Ä COOKIE ---
        
        // H√†m l∆∞u cookie
        function saveCookie() {
            const cookieVal = document.getElementById('cookieInput').value;
            localStorage.setItem('mes_cookie', cookieVal);
        }

        // H√†m load cookie
        function loadCookie() {
            const savedCookie = localStorage.getItem('mes_cookie');
            if(savedCookie) {
                document.getElementById('cookieInput').value = savedCookie;
            }
        }

        // Kh·ªüi t·∫°o ng√†y th√°ng
        function initializeDates() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setMonth(today.getMonth() - 1);
            
            const endDate = new Date(startDate);
            endDate.setMonth(startDate.getMonth() + 6);
            
            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            
            document.getElementById('startDate').addEventListener('change', function() {
                const start = new Date(this.value);
                const end = new Date(start);
                end.setMonth(start.getMonth() + 6);
                document.getElementById('endDate').valueAsDate = end;
            });

            // L·∫Øng nghe s·ª± ki·ªán nh·∫≠p cookie ƒë·ªÉ l∆∞u
            document.getElementById('cookieInput').addEventListener('input', saveCookie);
            loadCookie();
        }

        // --- H√ÄM X·ª¨ L√ù S·∫ÆP X·∫æP (SORTING) ---

        /**
         * H√†m s·∫Øp x·∫øp chung cho Package Group
         * @param {string} column T√™n tr∆∞·ªùng d·ªØ li·ªáu (key trong object)
         * @param {string} type Lo·∫°i d·ªØ li·ªáu: 'string', 'number', 'date'
         */
        function sortGroupTable(column, type) {
            handleSort(allGroupPackages, column, type, 'groupPackagesTable', displayGroupPackages);
        }

        /**
         * H√†m s·∫Øp x·∫øp chung cho MES Package
         */
        function sortMesTable(column, type) {
            handleSort(allMxPackages, column, type, 'mesPackagesTable', (data) => displayMxPackages(data, currentPackageGroup));
        }

        /**
         * Logic s·∫Øp x·∫øp c·ªët l√µi
         */
        function handleSort(dataArray, column, type, tableId, renderFunction) {
            // X√°c ƒë·ªãnh h∆∞·ªõng s·∫Øp x·∫øp
            if (sortState.column === column) {
                // N·∫øu ƒëang click l·∫°i c·ªôt c≈©, ƒë·∫£o ng∆∞·ª£c h∆∞·ªõng
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // N·∫øu click c·ªôt m·ªõi
                // M·∫∑c ƒë·ªãnh Ng√†y th√°ng: M·ªõi nh·∫•t tr∆∞·ªõc (desc)
                // S·ªë v√† Ch·ªØ: B√© ƒë·∫øn l·ªõn (asc)
                if (type === 'date') {
                    sortState.direction = 'desc';
                } else {
                    sortState.direction = 'asc';
                }
                sortState.column = column;
            }

            // C·∫≠p nh·∫≠t UI Header (M≈©i t√™n)
            updateSortIcons(tableId, column, sortState.direction);

            // Th·ª±c hi·ªán s·∫Øp x·∫øp m·∫£ng d·ªØ li·ªáu
            dataArray.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // X·ª≠ l√Ω null/undefined
                if (valA == null) valA = "";
                if (valB == null) valB = "";

                let comparison = 0;

                switch (type) {
                    case 'number':
                        valA = parseFloat(valA) || 0;
                        valB = parseFloat(valB) || 0;
                        comparison = valA - valB;
                        break;
                    case 'date':
                        // Gi·∫£ s·ª≠ ƒë·ªãnh d·∫°ng YYYY-MM-DD ho·∫∑c YYYYMMDD
                        const dateA = new Date(valA.toString().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
                        const dateB = new Date(valB.toString().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
                        comparison = dateA - dateB;
                        break;
                    default: // string
                        valA = valA.toString().toLowerCase();
                        valB = valB.toString().toLowerCase();
                        if (valA < valB) comparison = -1;
                        if (valA > valB) comparison = 1;
                        break;
                }

                return sortState.direction === 'asc' ? comparison : -comparison;
            });

            // Render l·∫°i b·∫£ng
            renderFunction(dataArray);
        }

        function updateSortIcons(tableId, activeColumn, direction) {
            const headers = document.querySelectorAll(`#${tableId} th.sortable`);
            headers.forEach(th => {
                th.classList.remove('asc', 'desc');
                // Ki·ªÉm tra xem header n√†y c√≥ ph·∫£i c·ªôt ƒëang sort kh√¥ng (d·ª±a v√†o onclick text ho·∫∑c logic kh√°c)
                // ·ªû ƒë√¢y ta check ƒë∆°n gi·∫£n b·∫±ng c√°ch clear h·∫øt tr∆∞·ªõc
                if (th.getAttribute('onclick').includes(`'${activeColumn}'`)) {
                    th.classList.add(direction);
                }
            });
        }

        // --- API REQUEST ---

        async function makeRequest(endpoint, params = {}) {
            const cookieInput = document.getElementById('cookieInput').value.trim();
            if (!cookieInput) { alert('Vui l√≤ng nh·∫≠p MES Cookie!'); return null; }
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                const url = new URL(endpoint, WORKER_URL);
                Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));

                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'X-MES-Cookie': cookieInput, 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || `HTTP ${response.status}`);
                return data;
            } catch (error) {
                alert(`L·ªói: ${error.message}`);
                return null;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function testHealth() {
            const data = await makeRequest('/health');
            if (data) alert(`‚úÖ K·∫øt n·ªëi Worker t·ªët!\nTime: ${data.timestamp}`);
        }

        // --- GROUP PACKAGES ---

        async function getGroupPackages() {
            // Reset sort state khi t√¨m ki·∫øm m·ªõi
            sortState = { column: null, direction: 'asc' };
            // Clear sort icons
            document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('asc', 'desc'));

            const params = {
                factory: document.getElementById('factory').value,
                plnStartDate: document.getElementById('startDate').value.replace(/-/g, ''),
                plnEndDate: document.getElementById('endDate').value.replace(/-/g, ''),
                buyer: document.getElementById('buyer').value,
                aoNumber: document.getElementById('aoNumber').value,
                styleInf: document.getElementById('styleCode').value,
                buyerPO: document.getElementById('buyerPO').value,
                _search: 'false', rows: '100', page: '1', sidx: 'BuyerPO', sord: 'asc'
            };

            const data = await makeRequest('/api/group-packages', params);
            if (data && data.success) {
                // L∆∞u d·ªØ li·ªáu v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ sort
                allGroupPackages = data.data.rows || [];
                displayGroupPackages(allGroupPackages);
            }
        }

        function displayGroupPackages(rows) {
            if (!rows || rows.length === 0) {
                alert('Kh√¥ng t√¨m th·∫•y package n√†o!');
                return;
            }
            
            document.getElementById('resultCount').textContent = rows.length;
            let html = '';
            rows.forEach(row => {
                html += `
                    <tr>
                        <td>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="clickable" onclick="getMxPackages('${row.PackageGroup}')">${row.PackageGroup}</span>
                                <button class="copy-icon-btn" onclick="copyText('${row.PackageGroup}')" title="Copy">üìã</button>
                            </div>
                        </td>
                        <td>${row.StyleCode || ''}</td>
                        <td>${row.BuyerPO || ''}</td>
                        <td class="text-right font-mono">${(row.TargetQty || 0).toLocaleString()}</td>
                        <td><span class="status-badge status-${row.Status}">${row.StatusName || row.Status}</span></td>
                        <td>${row.MesPlnStartDate || ''}</td>
                        <td>${row.MesPlnEndDate || ''}</td>
                        <td>${row.StyleColorways || ''}</td>
                    </tr>
                `;
            });
            
            document.getElementById('groupPackagesBody').innerHTML = html;
            switchSection('group');
        }

        // --- MES PACKAGES ---

        async function getMxPackages(packageGroup) {
            currentPackageGroup = packageGroup;
            // Reset sort state local
            sortState = { column: null, direction: 'asc' }; 
            
            const data = await makeRequest('/api/mes-packages', { packageGroup: packageGroup, mesPkgType: 'P' });
            if (data && data.success) {
                allMxPackages = data.data;
                displayMxPackages(allMxPackages, packageGroup);
            }
        }

        function displayMxPackages(data, packageGroup) {
            document.getElementById('currentPackageGroup').textContent = packageGroup;
            let html = '';
            data.forEach(row => {
                html += `
                    <tr>
                        <td>
                            <div style="display:flex; justify-content:space-between;">
                                <span>${row.MxPackage || ''}</span>
                                <button class="copy-icon-btn" onclick="copyText('${row.MxPackage}')">üìã</button>
                            </div>
                        </td>
                        <td>${row.LineName || ''}</td>
                        <td><span class="status-badge status-${row.MxStatus}">${row.StatusName || row.MxStatus}</span></td>
                        <td>${row.PlnStartDate || ''}</td>
                        <td>${row.PlnEndDate || ''}</td>
                        <td class="text-right font-mono">${(row.FinishedQty || 0).toLocaleString()}</td>
                        <td class="text-right font-mono">${(row.MxTarget || 0).toLocaleString()}</td>
                        <td class="text-right">${row.WorkingHours || 0}</td>
                        <td><button class="btn-info" style="padding: 4px 10px; font-size: 12px;" onclick="getProPackages('${row.MxPackage}')">Pro Pkg</button></td>
                    </tr>
                `;
            });
            document.getElementById('mesPackagesBody').innerHTML = html;
            switchSection('mes');
        }

        // --- PRO PACKAGES ---

        async function getProPackages(mxPackage) {
            const data = await makeRequest('/api/pro-packages', { packageGroup: currentPackageGroup });
            if (data && data.success) {
                document.getElementById('currentProPackage').textContent = mxPackage;
                let html = '';
                data.data.forEach(row => {
                    html += `
                        <tr>
                            <td>${row.PPackage || ''}</td>
                            <td>${row.SeqNo || ''}</td>
                            <td class="text-right font-mono">${(row.OrdQty || 0).toLocaleString()}</td>
                            <td class="text-right font-mono">${(row.PlanQty || 0).toLocaleString()}</td>
                            <td class="text-right font-mono">${(row.CompletedQty || 0).toLocaleString()}</td>
                            <td>${row.LINENO || ''}</td>
                            <td>${row.QCOWeekNo || ''}</td>
                            <td>${row.Destination || ''}</td>
                        </tr>
                    `;
                });
                document.getElementById('proPackagesBody').innerHTML = html;
                switchSection('pro');
            }
        }

        // --- UTILS & NAVIGATION ---

        function switchSection(id) {
            ['groupPackagesResults', 'mesPackagesResults', 'proPackagesResults'].forEach(sid => {
                document.getElementById(sid).classList.add('hidden');
            });
            // N·∫øu kh√¥ng ph·∫£i trang config, ·∫©n config ƒëi cho g·ªçn (t√πy ch·ªçn)
            // document.getElementById('configSection').classList.add('hidden'); 
            
            if (id === 'group') document.getElementById('groupPackagesResults').classList.remove('hidden');
            if (id === 'mes') document.getElementById('mesPackagesResults').classList.remove('hidden');
            if (id === 'pro') document.getElementById('proPackagesResults').classList.remove('hidden');
        }

        function backToGroupPackages() { switchSection('group'); }
        function backToMxPackages() { switchSection('mes'); }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                // C√≥ th·ªÉ th√™m toast notification ·ªü ƒë√¢y
            });
        }

        function copyAllPackageGroups() {
            if(!allGroupPackages.length) return;
            const text = allGroupPackages.map(p => p.PackageGroup).join('\n');
            copyText(text);
            alert(`ƒê√£ copy ${allGroupPackages.length} Package Groups`);
        }

        function copyAllMxPackages() {
            if(!allMxPackages.length) return;
            const text = allMxPackages.map(p => p.MxPackage).join('\n');
            copyText(text);
            alert(`ƒê√£ copy ${allMxPackages.length} Mx Packages`);
        }

        function exportGroupPackagesCSV() {
            if (!allGroupPackages.length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu!');
            const headers = ['PackageGroup', 'StyleCode', 'BuyerPO', 'TargetQty', 'Status', 'MesPlnStartDate', 'MesPlnEndDate', 'StyleColorways'];
            const content = [headers.join(','), ...allGroupPackages.map(r => headers.map(h => `"${(r[h]||'').toString().replace(/"/g, '""')}"`).join(','))].join('\n');
            downloadCSV(content, 'GroupPackages.csv');
        }

        function exportMxPackagesCSV() {
            if (!allMxPackages.length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu!');
            const headers = ['MxPackage', 'LineName', 'MxStatus', 'PlnStartDate', 'PlnEndDate', 'FinishedQty', 'MxTarget'];
            const content = [headers.join(','), ...allMxPackages.map(r => headers.map(h => `"${(r[h]||'').toString().replace(/"/g, '""')}"`).join(','))].join('\n');
            downloadCSV(content, `MxPackages-${currentPackageGroup}.csv`);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
        }

        window.addEventListener('load', initializeDates);
    </script>
</body>
</html>
